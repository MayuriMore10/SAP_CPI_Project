<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Variables - SAP CPI Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css" />
</head>
<body class="light">
    <div class="layout">
        <aside class="sidebar">
            <div class="brand">Dashboard</div>
            <nav>
                <a href="/login">Login</a>
                <a href="/">Home</a>
                <a href="/show">Message Stores</a>
            </nav>
        </aside>
        <main class="content">
            <div class="container">
                <h1>Variables</h1>
                <div class="card">
                    <h2>Overview</h2>
                    <p>Variables in SAP Integration Suite are configuration parameters that can be set at the integration flow level. They provide flexibility and reusability by allowing you to externalize configuration values without modifying the integration flow.</p>
                </div>
                <div class="actions">
                    <button id="btnLoadVariables">Load Variables</button>
                    <button id="btnClear" class="ghost">Clear</button>
                </div>
                <div id="tableWrap" class="table-wrap"></div>
            </div>
        </main>
    </div>

    <script>
    const tableWrap = document.getElementById('tableWrap');
    function renderTable(items){
        if (!Array.isArray(items)) items = [];
        if (items.length === 0){ tableWrap.innerHTML = '<div class="muted">No data available</div>'; return; }
        const columns = Object.keys(items[0]);
        let html = '<table class="table"><thead><tr>' + columns.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>';
        for (const row of items){
            html += '<tr>' + columns.map(c=>`<td>${escapeHtml(row[c])}</td>`).join('') + '</tr>';
        }
        html += '</tbody></table>';
        tableWrap.innerHTML = html;
    }
    function escapeHtml(v){
        if (v == null) return '';
        return String(v).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }
    async function fetchAndRender(path){
        try {
            const res = await fetch(path);
            const data = await res.json();
            const items = normalize(data);
            renderTable(items);
        } catch (err) {
            tableWrap.innerHTML = `<div class="error">Error: ${err.message}</div>`;
        }
    }
    function normalize(resp){
        if (!resp || !resp.data) return [];
        const data = resp.data;
        if (data.d && Array.isArray(data.d.results)){
            return data.d.results.map(pick);
        }
        if (data.d && typeof data.d === 'object'){
            return [pick(data.d)];
        }
        return [];
    }
    function pick(obj){
        console.log('Available fields in Variable:', Object.keys(obj));
        const out = {};
        for (const key in obj) {
            if (obj.hasOwnProperty(key)) {
                // Format date fields
                if (key.includes('Date') || key.includes('At') || key.includes('Time') || key === 'RetainUntil') {
                    out[key] = formatDate(obj[key]);
                } else {
                    out[key] = obj[key];
                }
            }
        }
        return out;
    }
    
    function formatDate(dateString) {
        if (!dateString) return '';
        try {
            let date;
            
            // Handle Microsoft .NET JSON date format: /Date(1757510738298)/
            if (dateString.includes('/Date(') && dateString.includes(')/')) {
                const timestamp = dateString.match(/\/Date\((\d+)\)\//);
                if (timestamp && timestamp[1]) {
                    date = new Date(parseInt(timestamp[1]));
                }
            }
            // Handle ISO format: 2023-12-25T10:30:00Z
            else if (dateString.includes('T')) {
                date = new Date(dateString);
            }
            // Handle already formatted dates
            else if (dateString.includes('/')) {
                return dateString;
            }
            // Try parsing as regular timestamp or other format
            else {
                date = new Date(dateString);
            }
            
            if (!date || isNaN(date.getTime())) return dateString;
            
            // Format as DD/MM/YYYY
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}/${month}/${year}`;
        } catch (e) {
            return dateString;
        }
    }
    document.getElementById('btnLoadVariables').addEventListener('click', ()=> fetchAndRender('/api/variables/all'));
    document.getElementById('btnClear').addEventListener('click', ()=> { tableWrap.innerHTML = ''; });
    </script>
</body>
</html>
